
%TOC%
---++ Overview

Conduit-lite refers to the conduit setup in cloud environments where typically low volume data streams are generated by producers. Hence hadoop cluster may not provide cost benefit. Instead Amazon S3 service is used to store data. S3 is designed to provide extremely high durability (upto 99.9 nines's). Also note that there is no Job Tracker to execute conduit-lite MR jobs. Instead these jobs are executed in the local runner.

---++ Topology

The recommended topology to setup conduit-lite in a cluster is:

   1. Configure an instance of scribe agent to run locally on the same box as the message publisher. The publisher writes messages to the local scribe agent, thus providing high write throughput and isolation from any downstream failure. Scribe agent should be configured to write to scribe collector(s). The agent is capable of handling various downstream failure scenarios and ensure that there is no data-loss by spooling data to its local disk and periodically de-spooling.
   1. Configure an instance of scribe collector(s), each running on a separate machine. The scribe collector should be configured to write to S3/S3N service, as mentioned in [["./ConduitLite.html#Setup_on_S3_S3N"][setup]] below.
   1. Conduit typically supports message sizes of ~2-3K. However it has been successfully used to send messages upto 10K size as well.
---++ Setup on S3/S3N
---+++ Conduit-lite setup

The following link describes how to configure conduit-lite: [[ConduitLiteSetup][Setup]]

---+++ Configuration for S3/S3N

The following link describes how to make S3/S3N specific configurations: [[ConduitLiteConfig][Configuration changes for S3/S3N]]

---+++ Configure Access to users

The following link describes how to configure read only/write access to users in AWS: <span style="color: blue;">[[ConduitLiteReadAccess][Give Access to users]]</span>

---+++ Using S3NativeCopyMapper

The S3NativeCopyMapper class is used to do server side copy within the S3 buckets.The copy mapper reduces the need to stream the data from S3 bucket to EC2 client on which CopyMapper runs.

In order to use S3NativeCopyMapper within conduit lite configure the cluster in the conduit.xml to use copy mapper implemenation as following:

<verbatim>
  <cluster name="" hdfsurl="s3n:///"
   jturl=""
   jobqueuename=""
   copyMapperClass = "com.inmobi.databus.local.S3NCopyMapper"/>
</verbatim>

Please note that the S3NativeCopyMapper works with S3N filesystem.

---++ Benchmarking

Here are the results of various benchmarking tests done on EC2 cluster:
---+++ Latency

Refer to the results in [[https://bugs.corp.inmobi.com/show_bug.cgi?id=52380][52380]].

Notes:

   1 The above test covers the scenario of scribe collector writing to S3 bucket and conduit local/merge/mirror stream services processing files in S3. Latency is calculated by different consumers that read data written by collector/local/merge/mirror stream writers.
   1 Merge/mirror stream is configured across different regions.
   1 This test finds the *mean latency* (average latency to read all messages). In general, the order of mean latency (for collector/local/merge/mirror) is *(&lt;1 min/3-4 min/4-5 min/5-6 min)*.
   1 This test does not cover *percentile latency*. However it should be possible to find percentile latency by using conduit audit feature exposed through audit dashboard. Please refer to [[https://twiki.corp.inmobi.com/TechPlatform/ConduitVisualization][Conduit visualization]] for more details.

---+++ Throughput

A) Refer to *producer/agent/collector throughput* results in [[https://jira.corp.inmobi.com/browse/DBUS-100][DBUS-100]].

Notes:

   1 This test finds the maximum acceptable write throughput of producer/agent/collector that ensures steady state, i.e. no message loss at producer, or no spooling at agent/collector.
   1 The observed throughput is highly dependent on the EC2 instance type used. In general, m1.medium instance runs into high load average/CPU %wa and gives inconsistent results when co-hosting publisher and scribe agent. At least *m1.large instance* is recommended.
B) Refer to *consumer throughput* results in [[https://jira.corp.inmobi.com/browse/DBUS-101][DBUS-101]].

Notes:

   1 The consumer library is able to exhaust the maximum throughput provided by network and the underlying storage system where messages are written (S3/HDFS).
   1 If a consumer application is lagging behind producer rate and wants to increase its consume throughput by parallelizing itself, it can run multiple consumers by configuring <strong>consumer groups. </strong>Please refer to [[https://twiki.corp.inmobi.com/TechPlatform/MessagingClient#Consumer_Group][consumer group]] for more details.
---++ Capacity planning

In order to perform capacity planning, you can use the throughput results described in the [[https://twiki.corp.inmobi.com/TechPlatform/ConduitLite#Throughput][throughput]] section above. The aim is to have a conduit-lite setup where the system is running in *steady state*, i.e. there is no message loss/spooling happening at either of publisher, agent or collector tiers.

   1 In order to write total of 'N' MB/s through conduit-lite layer, *minimum collector nodes needed = N/(max collector write throughput)*. If more than 1 collector is needed, then you would need to configure a VIP layer between scribe agents and collectors.
   1 The <strong>minimum (publisher + scribe agent) nodes needed = N/ (max agent write throughput) </strong>in steady state. Note that publisher message queue size/scribe agent settings needs to be configured appropriately.
   1 Scribe agent and collector nodes need to have sufficient disk space available in order to spool/de-spool data in case of rate mismatch.

---++ Monitoring

The messaging-client (pintail) library provided as part of conduit-lite comprises of two components: publisher and consumer. Both components expose their own set of monitoring stats through mondemand. Please refer to the section [[https://twiki.corp.inmobi.com/TechPlatform/MessagingClient#Monitoring_for_publisher][Monitoring for Publisher]] and [[https://twiki.corp.inmobi.com/TechPlatform/MessagingClient#Monitoring_for_Consumer][Monitoring for Consumer]] for more details.

---++ Dev investigation

The tracking bug for dev investigation to support conduit on S3 is [[https://bugs.corp.inmobi.com/show_bug.cgi?id=40079][40079]]

